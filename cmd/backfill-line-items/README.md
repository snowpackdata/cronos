# Line Items Backfill Script

This script generates line items for all existing invoices and bills in the database.

## What It Does

### For Invoices:
- Groups entries by billing code into single line items
- Creates separate line items for adjustments (fees/credits)
- Preserves traceability via entry IDs

### For Bills:
- Creates line items for timesheet hours (grouped by billing code)
- Creates separate line items for commissions
- Creates separate line items for adjustments

## Usage

### Dry Run (Preview Only)
```bash
# SQLite (local development)
go run main.go -dry-run

# PostgreSQL (CloudSQL) - requires Cloud SQL Proxy running
go run main.go -db postgres \
  -host localhost \
  -port 5432 \
  -user your-user \
  -password your-password \
  -name cronos \
  -dry-run
```

### Actual Migration
```bash
# SQLite
go run main.go

# PostgreSQL
go run main.go -db postgres \
  -host localhost \
  -port 5432 \
  -user your-user \
  -password your-password \
  -name cronos
```

### CloudSQL Authentication

If using CloudSQL (PostgreSQL), start the Cloud SQL Proxy first:

```bash
# In a separate terminal window
./cloud-sql-proxy snowpack-data-warehouse:us-west1:cronos-prod \
  --port 5432 \
  --credentials-file=path/to/service-account-key.json
```

Then set the environment variables and run the backfill.

## What Gets Created

### Invoice Line Items
- **Type**: `LINE_ITEM_TYPE_TIMESHEET` or `LINE_ITEM_TYPE_ADJUSTMENT`
- **Description**: E.g., "Development (ACME_0001) - 12.5 hours" or "Fee: Additional services"
- **Quantity**: Hours (for timesheets, 0 for adjustments)
- **Rate**: Hourly rate (for timesheets)
- **Amount**: Total in cents
- **References**: BillingCodeID, EntryIDs (JSON array), AdjustmentID

### Bill Line Items
- **Type**: `LINE_ITEM_TYPE_TIMESHEET`, `LINE_ITEM_TYPE_COMMISSION`, or `LINE_ITEM_TYPE_ADJUSTMENT`
- **Description**: E.g., "Development - 8.0 hours", "Commission - AE", "Fee: Bonus"
- **Quantity**: Hours (for timesheets, 0 for others)
- **Rate**: Internal hourly rate (for timesheets)
- **Amount**: Total in cents
- **References**: BillingCodeID, EntryIDs, CommissionID, AdjustmentID

## Verification

After running, the script displays:
- Number of invoices/bills processed
- Number of invoices/bills skipped (already have line items)
- Total line items created

You can verify in the database:
```sql
-- Check invoice line items
SELECT invoice_id, type, description, quantity, rate, amount 
FROM invoice_line_items 
ORDER BY invoice_id;

-- Check bill line items
SELECT bill_id, type, description, quantity, rate, amount 
FROM bill_line_items 
ORDER BY bill_id;

-- Verify totals match
SELECT i.id, i.total_amount, 
       SUM(ili.amount) as line_items_total
FROM invoices i
LEFT JOIN invoice_line_items ili ON ili.invoice_id = i.id
WHERE i.type = 'INVOICE_TYPE_ACCOUNTS_RECEIVABLE'
GROUP BY i.id
HAVING i.total_amount != SUM(ili.amount);
```

## Safety

- The script skips invoices/bills that already have line items
- Use `-dry-run` to preview changes before applying
- Line items are idempotent - can be regenerated by deleting and re-running

## Notes

- This should be run AFTER the journal migration
- Invoices/bills in `VOID` state are skipped
- Only processes hourly/timesheet components (no salary calculations)
- Commissions are included in bill line items
- Line items are used by journal entry creation for cleaner accounting

