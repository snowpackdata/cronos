import{N as e,h as t,r as a,b as s,w as l,f as n,c as r,a as o,q as i,x as c,z as d,F as u,G as m,y as g,v,X as p,E as x,o as y,n as f,_ as h}from"./index-2uCPEpPG.js";const b=async(e,t)=>{try{const a=localStorage.getItem("snowpack_token"),s=await fetch(`/api/capacity/detail?assignment_id=${e}&week_start=${t}`,{headers:{"x-access-token":a||""}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return await s.json()}catch(a){throw console.error("Error fetching capacity entries:",a),a}},w={class:"px-4 py-4 sm:px-6 lg:px-8"},k={class:"sm:flex sm:items-center"},j={class:"mt-3 sm:ml-16 sm:mt-0 sm:flex-none"},_={class:"inline-flex rounded-md shadow-sm",role:"group"},C={key:0,class:"flex flex-col items-center justify-center p-6 bg-white rounded-lg shadow mt-4"},D={key:1,class:"flex flex-col items-center justify-center p-6 bg-white rounded-lg shadow mt-4"},$={class:"text-sm text-gray-dark mb-1"},T={key:2,class:"mt-4 bg-white rounded-lg shadow overflow-hidden"},A={class:"overflow-x-auto"},U={class:"inline-block min-w-full align-middle"},E={class:"gantt-container"},F={class:"gantt-header"},S={class:"gantt-label-column"},M={class:"p-2 text-xs font-semibold text-gray-dark"},N={class:"gantt-timeline"},z={class:"week-label"},I={key:0,class:"current-week-indicator"},K=["onClick"],P={class:"gantt-label-column"},L={class:"px-2 py-1.5 flex items-center cursor-pointer"},B={class:"text-xs font-semibold text-gray-700"},H={class:"gantt-timeline"},V={class:"relative"},Y=["title","onClick"],q={class:"gantt-bar-text"},G={key:1,class:"gantt-row gantt-row-child"},O={class:"gantt-label-column"},R={class:"p-2 pl-8"},W={class:"text-xs font-medium text-gray-600"},X={class:"gantt-timeline"},Z=["title","onClick"],J={class:"gantt-bar-text"},Q={class:"gantt-totals-row"},ee={class:"gantt-timeline"},te={class:"text-xs font-semibold text-gray-dark"},ae={class:"gantt-totals-row"},se={class:"gantt-timeline"},le={class:"text-xs font-semibold text-gray-dark"},ne={class:"gantt-totals-row"},re={class:"gantt-timeline"},oe={key:0,class:"p-8 text-center"},ie={class:"bg-white px-6 py-4 border-b border-gray-200 rounded-t-lg"},ce={class:"flex justify-between items-start"},de={class:"text-lg font-semibold text-gray-900"},ue={class:"text-sm text-gray-600 mt-1"},me={key:0,class:"overflow-y-auto flex-1 px-6 py-4"},ge={class:"grid grid-cols-3 gap-4 mb-4"},ve={class:"bg-gray-50 border border-gray-200 p-3 rounded-lg"},pe={class:"text-2xl font-semibold text-gray-900"},xe={class:"bg-gray-50 border border-gray-200 p-3 rounded-lg"},ye={class:"text-2xl font-semibold text-gray-900"},fe={class:"bg-gray-50 border border-gray-200 p-3 rounded-lg"},he={class:"border-t pt-4 mt-4"},be={class:"space-y-2 text-sm"},we={class:"flex justify-between"},ke={class:"text-gray"},je={class:"text-gray-dark font-medium"},_e={key:0,class:"flex justify-between"},Ce={class:"text-gray-dark font-medium"},De={class:"flex justify-between"},$e={class:"text-gray-dark font-medium"},Te={key:0,class:"border-t pt-4"},Ae={class:"overflow-x-auto"},Ue={class:"min-w-full divide-y divide-gray-200"},Ee={class:"bg-white divide-y divide-gray-200"},Fe={class:"px-3 py-2 whitespace-nowrap text-xs text-gray-dark"},Se={class:"px-3 py-2 text-xs text-gray-dark"},Me={class:"px-3 py-2 whitespace-nowrap text-right text-xs font-medium text-gray-dark"},Ne={key:1,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-3"},ze=h(t({__name:"CapacityView",setup(t){const h=a(!0),ze=a(null),Ie=a([]),Ke=a("project"),Pe=a(null),Le=a(null),Be=a(!1),He=a(new Set),Ve=a(null),Ye=a([]),qe=a(null),Ge=a((()=>{const e=[],t=new Date,a=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),s=a.getUTCDay();a.setUTCDate(a.getUTCDate()-s);for(let l=-12;l<=12;l++){const t=new Date(a);t.setUTCDate(a.getUTCDate()+7*l),e.push(t)}return e})()),Oe=(e,t,a)=>{const s=e.getTime(),l=new Date(t).getTime(),n=new Date(a).getTime();return s>=l&&s<=n},Re=s(()=>{if("project"===Ke.value){const e=new Map;Ie.value.forEach(t=>{var a;const s=(null==(a=t.project.account)?void 0:a.name)||"Unknown";e.has(s)||e.set(s,new Map);const l=e.get(s);l.has(t.project_id)||l.set(t.project_id,{name:t.project.name,assignments:[]}),l.get(t.project_id).assignments.push(t)});const t=[];return Array.from(e.entries()).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,a])=>{const s=`account-${e}`,l=[];a.forEach(e=>{l.push(...e.assignments)});Ge.value.some(e=>Ze(l,e)>0)&&(t.push({type:"group",groupKey:s,groupName:e,allAssignments:l}),He.value.has(s)&&Array.from(a.entries()).sort((e,t)=>e[1].name.localeCompare(t[1].name)).forEach(([e,a])=>{t.push({type:"item",id:e,label:a.name,assignments:a.assignments})}))}),t}{const e=new Map;Ie.value.forEach(t=>{var a;e.has(t.employee_id)||e.set(t.employee_id,{name:`${t.employee.first_name} ${t.employee.last_name}`,projectAssignments:new Map});const s=e.get(t.employee_id);s.projectAssignments.has(t.project_id)||s.projectAssignments.set(t.project_id,{projectName:t.project.name,accountName:(null==(a=t.project.account)?void 0:a.name)||"Unknown",assignments:[]}),s.projectAssignments.get(t.project_id).assignments.push(t)});const t=[];return Array.from(e.entries()).sort((e,t)=>e[1].name.localeCompare(t[1].name)).forEach(([e,a])=>{const s=`staff-${e}`,l=[];a.projectAssignments.forEach(e=>{l.push(...e.assignments)});Ge.value.some(e=>Ze(l,e)>0)&&(t.push({type:"group",groupKey:s,groupName:a.name,allAssignments:l}),He.value.has(s)&&Array.from(a.projectAssignments.entries()).sort((e,t)=>e[1].projectName.localeCompare(t[1].projectName)).forEach(([e,a])=>{t.push({type:"item",id:e,label:`${a.projectName} (${a.accountName})`,assignments:a.assignments})}))}),t}}),We=s(()=>Ge.value.map(e=>{let t=0,a=0;Ie.value.forEach(s=>{Oe(e,s.start_date,s.end_date)&&(t+=Xe(s,e),a+=st(s,e))});return{committed:t,billed:a,utilization:t>0?a/t*100:0}})),Xe=(e,t)=>{if(e.segments&&e.segments.length>0){const a=tt(t);for(const t of e.segments)if(a>=t.start_date&&a<=t.end_date)return t.commitment;return 0}return e.commitment},Ze=(e,t)=>{let a=0;return e.forEach(e=>{Oe(t,e.start_date,e.end_date)&&(a+=Xe(e,t))}),a},Je=(e,t)=>{let a=0;const s=[];return e.forEach(e=>{var l,n,r;const o=st(e,t);o>0&&s.push({assignment_id:e.ID,project:null==(l=e.project)?void 0:l.name,employee:`${null==(n=e.employee)?void 0:n.first_name} ${null==(r=e.employee)?void 0:r.last_name}`,hours:o}),a+=o}),s.length,a},Qe=(e,t)=>{const a=Ze(e,t),s=Je(e,t);return a>0?s/a*100:0},et=e=>{const t=20+(Math.min(Math.max(e,5),40)-5)/35*20;return`${Math.round(t)}px`},tt=e=>`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`,at=(e,t)=>{var a;const s=tt(t),l=null==(a=e.weekly_utilization)?void 0:a[s];if(!l&&Xe(e,t)>0){Object.keys(e.weekly_utilization||{}).length}return(null==l?void 0:l.utilization)||0},st=(e,t)=>{var a;const s=tt(t),l=null==(a=e.weekly_utilization)?void 0:a[s];return(null==l?void 0:l.actual_hours)||0},lt=e=>e>100?"#dc2626":"#58837e",nt=e=>Math.min(e,100),rt=()=>{Be.value=!1,Pe.value=null,Le.value=null,Ve.value=null,Ye.value=[]};l(Be,e=>{e&&f(()=>{var e;null==(e=qe.value)||e.focus()})});const ot=e=>`${e.toLocaleDateString("en-US",{month:"short",timeZone:"UTC"})} ${e.getUTCDate()}`,it=e=>{const t=new Date,a=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),s=a.getUTCDay();return a.setUTCDate(a.getUTCDate()-s),e.getTime()===a.getTime()},ct=async()=>{h.value=!0,ze.value=null;try{const t=await(async()=>{try{return await e("capacity")}catch(ze){throw console.error("Error fetching capacity data:",ze),ze}})();Ie.value=t,t.length}catch(t){console.error("Error loading capacity data:",t),ze.value="Failed to load capacity data. Please try again."}finally{h.value=!1}};return n(async()=>{await ct(),Ge.value.findIndex(e=>it(e))>=0&&setTimeout(()=>{const e=document.querySelector(".gantt-week-header.current-week");e&&e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},100)}),(e,t)=>{var a,s,l;return y(),r("div",w,[o("div",k,[t[3]||(t[3]=o("div",{class:"sm:flex-auto"},[o("h1",{class:"text-base font-semibold leading-6 text-blue"},"Capacity Management"),o("p",{class:"mt-1 text-xs text-gray"},"View project and staff commitments historically and into the future.")],-1)),o("div",j,[o("div",_,[o("button",{type:"button",onClick:t[0]||(t[0]=e=>Ke.value="project"),class:c(["project"===Ke.value?"bg-sage text-white":"bg-white text-gray-dark hover:bg-gray-50","px-3 py-1.5 text-xs font-semibold rounded-l-md border border-gray-300"])}," By Project ",2),o("button",{type:"button",onClick:t[1]||(t[1]=e=>Ke.value="staff"),class:c(["staff"===Ke.value?"bg-sage text-white":"bg-white text-gray-dark hover:bg-gray-50","px-3 py-1.5 text-xs font-semibold rounded-r-md border border-gray-300 border-l-0"])}," By Staff ",2)])])]),h.value?(y(),r("div",C,t[4]||(t[4]=[o("i",{class:"fas fa-spinner fa-spin text-3xl text-teal mb-2"},null,-1),o("span",{class:"text-sm text-gray-dark"},"Loading capacity data...",-1)]))):ze.value?(y(),r("div",D,[t[5]||(t[5]=o("i",{class:"fas fa-exclamation-circle text-3xl text-red mb-2"},null,-1)),o("span",$,d(ze.value),1),o("button",{onClick:ct,class:"mt-3 px-3 py-1.5 text-xs font-semibold text-white bg-sage rounded-md hover:bg-sage-dark"}," Retry ")])):(y(),r("div",T,[o("div",A,[o("div",U,[o("div",E,[o("div",F,[o("div",S,[o("div",M,d("project"===Ke.value?"Project":"Staff Member"),1)]),o("div",N,[(y(!0),r(u,null,m(Ge.value,(e,a)=>(y(),r("div",{key:a,class:c(["gantt-week-header",it(e)?"current-week":""])},[o("div",z,d(ot(e)),1),it(e)?(y(),r("div",I,t[6]||(t[6]=[o("i",{class:"fas fa-arrow-down text-xs"},null,-1)]))):i("",!0)],2))),128))])]),(y(!0),r(u,null,m(Re.value,e=>(y(),r(u,{key:"group"===e.type?`group-${e.groupKey}`:`item-${e.id}`},["group"===e.type?(y(),r("div",{key:0,class:"gantt-group-row",onClick:t=>{return a=e.groupKey,He.value.has(a)?He.value.delete(a):He.value.add(a),void(He.value=new Set(He.value));var a}},[o("div",P,[o("div",L,[o("i",{class:c(["fas text-xs mr-2 text-gray-500 transition-transform",He.value.has(e.groupKey)?"fa-chevron-down":"fa-chevron-right"])},null,2),o("div",B,d(e.groupName),1)])]),o("div",H,[(y(!0),r(u,null,m(Ge.value,(t,a)=>(y(),r("div",{key:a,class:c(["gantt-cell",it(t)?"current-week":""])},[o("div",V,[Ze(e.allAssignments,t)>0?(y(),r("div",{key:0,class:"gantt-bar gantt-bar-aggregated",style:v({height:et(Ze(e.allAssignments,t)),background:`linear-gradient(to right, ${lt(Qe(e.allAssignments,t))} ${nt(Qe(e.allAssignments,t))}%, ${lt(Qe(e.allAssignments,t))}40 ${nt(Qe(e.allAssignments,t))}%)`}),title:`${e.groupName} - ${Ze(e.allAssignments,t)}h/week (${Je(e.allAssignments,t).toFixed(1)}h actual, ${Qe(e.allAssignments,t).toFixed(0)}%)`,onClick:g(a=>(async(e,t)=>{if(e.length>0){Pe.value=e[0],Ve.value=e,Le.value=t,Be.value=!0;const s=[];for(const l of e)try{const e=await b(l.ID,tt(t));s.push(...e)}catch(a){console.error(`Failed to fetch detailed entries for assignment ${l.ID}:`,a)}Ye.value=s.sort((e,t)=>new Date(e.start).getTime()-new Date(t.start).getTime())}})(e.allAssignments,t),["stop"])},[o("span",q,d(Ze(e.allAssignments,t))+"h",1)],12,Y)):i("",!0)])],2))),128))])],8,K)):(y(),r("div",G,[o("div",O,[o("div",R,[o("div",W,d(e.label),1)])]),o("div",X,[(y(!0),r(u,null,m(Ge.value,(t,a)=>(y(),r("div",{key:a,class:c(["gantt-cell",it(t)?"current-week":""])},[(y(!0),r(u,null,m(e.assignments,e=>(y(),r("div",{key:e.ID,class:"relative"},[Oe(t,e.start_date,e.end_date)?(y(),r("div",{key:0,class:"gantt-bar",style:v({height:et(Xe(e,t)),background:`linear-gradient(to right, ${lt(at(e,t))} ${nt(at(e,t))}%, ${lt(at(e,t))}40 ${nt(at(e,t))}%)`}),title:`${"project"===Ke.value?e.employee.first_name+" "+e.employee.last_name:e.project.name} - ${Xe(e,t)}h/week (${st(e,t).toFixed(1)}h actual, ${at(e,t).toFixed(0)}%)`,onClick:g(a=>(async(e,t)=>{Pe.value=e,Le.value=t,Ve.value=null,Be.value=!0;try{Ye.value=await b(e.ID,tt(t))}catch(a){console.error("Failed to fetch detailed entries:",a),Ye.value=[]}})(e,t),["stop"])},[o("span",J,d(Xe(e,t))+"h",1)],12,Z)):i("",!0)]))),128))],2))),128))])]))],64))),128)),o("div",Q,[t[7]||(t[7]=o("div",{class:"gantt-label-column"},[o("div",{class:"p-2 text-xs font-semibold text-gray-dark"},"Committed")],-1)),o("div",ee,[(y(!0),r(u,null,m(Ge.value,(e,t)=>(y(),r("div",{key:t,class:c(["gantt-total-cell",it(e)?"current-week":""])},[o("span",te,d(We.value[t].committed)+"h",1)],2))),128))])]),o("div",ae,[t[8]||(t[8]=o("div",{class:"gantt-label-column"},[o("div",{class:"p-2 text-xs font-semibold text-gray-dark"},"Billed")],-1)),o("div",se,[(y(!0),r(u,null,m(Ge.value,(e,t)=>(y(),r("div",{key:t,class:c(["gantt-total-cell",it(e)?"current-week":""])},[o("span",le,d(We.value[t].billed.toFixed(1))+"h",1)],2))),128))])]),o("div",ne,[t[9]||(t[9]=o("div",{class:"gantt-label-column"},[o("div",{class:"p-2 text-xs font-semibold text-gray-dark"},"Utilization")],-1)),o("div",re,[(y(!0),r(u,null,m(Ge.value,(e,t)=>(y(),r("div",{key:t,class:c(["gantt-total-cell",it(e)?"current-week":""])},[o("span",{class:c(["text-xs font-semibold",We.value[t].utilization>100?"text-red-600":"text-gray-dark"])},d(We.value[t].utilization.toFixed(0))+"% ",3)],2))),128))])]),0===Re.value.length?(y(),r("div",oe,t[10]||(t[10]=[o("i",{class:"fas fa-calendar-times text-4xl text-gray mb-3"},null,-1),o("p",{class:"text-sm text-gray-dark"},"No capacity assignments found",-1)]))):i("",!0)])])])])),Be.value?(y(),r("div",{key:3,ref_key:"modalElement",ref:qe,class:"fixed inset-0 z-50 flex items-center justify-center px-4",onClick:rt,onKeydown:p(rt,["esc"]),tabindex:"-1"},[t[21]||(t[21]=o("div",{class:"fixed inset-0 bg-black/30 backdrop-blur-sm transition-opacity"},null,-1)),o("div",{class:"relative bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col",onClick:t[2]||(t[2]=g(()=>{},["stop"]))},[o("div",ie,[o("div",ce,[o("div",null,[o("h3",de,d("project"===Ke.value?null==(a=Pe.value)?void 0:a.project.name:(null==(s=Pe.value)?void 0:s.employee.first_name)+" "+(null==(l=Pe.value)?void 0:l.employee.last_name)),1),o("p",ue," Week of "+d(Le.value?ot(Le.value):""),1)]),o("button",{onClick:rt,class:"text-gray-400 hover:text-gray-600"},t[11]||(t[11]=[o("i",{class:"fas fa-times text-xl"},null,-1)]))])]),Pe.value&&Le.value?(y(),r("div",me,[o("div",ge,[o("div",ve,[t[12]||(t[12]=o("p",{class:"text-xs text-gray-600 mb-1"},"Commitment",-1)),o("p",pe,d(Ve.value?Ze(Ve.value,Le.value):Xe(Pe.value,Le.value))+"h ",1)]),o("div",xe,[t[13]||(t[13]=o("p",{class:"text-xs text-gray-600 mb-1"},"Actual Hours",-1)),o("p",ye,d(Ve.value?Je(Ve.value,Le.value).toFixed(1):st(Pe.value,Le.value).toFixed(1))+"h ",1)]),o("div",fe,[t[14]||(t[14]=o("p",{class:"text-xs text-gray-600 mb-1"},"Utilization",-1)),o("p",{class:c(["text-2xl font-semibold",(Ve.value?Qe(Ve.value,Le.value):at(Pe.value,Le.value))>100?"text-red-600":"text-sage"])},d((Ve.value?Qe(Ve.value,Le.value):at(Pe.value,Le.value)).toFixed(0))+"% ",3)])]),o("div",he,[t[17]||(t[17]=o("h4",{class:"text-sm font-semibold text-gray-dark mb-2"},"Assignment Details",-1)),o("div",be,[o("div",we,[o("span",ke,d("project"===Ke.value?"Staff Member":"Project")+":",1),o("span",je,d("project"===Ke.value?`${Pe.value.employee.first_name} ${Pe.value.employee.last_name}`:Pe.value.project.name),1)]),"staff"===Ke.value&&Pe.value.project.account?(y(),r("div",_e,[t[15]||(t[15]=o("span",{class:"text-gray"},"Account:",-1)),o("span",Ce,d(Pe.value.project.account.name),1)])):i("",!0),o("div",De,[t[16]||(t[16]=o("span",{class:"text-gray"},"Assignment Period:",-1)),o("span",$e,d(new Date(Pe.value.start_date).toLocaleDateString())+" - "+d(new Date(Pe.value.end_date).toLocaleDateString()),1)])])]),Ye.value.length>0?(y(),r("div",Te,[t[19]||(t[19]=o("h4",{class:"text-sm font-semibold text-gray-dark mb-3"},"Time Entries",-1)),o("div",Ae,[o("table",Ue,[t[18]||(t[18]=o("thead",{class:"bg-gray-50"},[o("tr",null,[o("th",{scope:"col",class:"px-3 py-2 text-left text-xs font-medium text-gray uppercase tracking-wider"},"Date"),o("th",{scope:"col",class:"px-3 py-2 text-left text-xs font-medium text-gray uppercase tracking-wider"},"Description"),o("th",{scope:"col",class:"px-3 py-2 text-right text-xs font-medium text-gray uppercase tracking-wider"},"Hours")])],-1)),o("tbody",Ee,[(y(!0),r(u,null,m(Ye.value,e=>{return y(),r("tr",{key:e.id,class:"hover:bg-gray-50"},[o("td",Fe,d((t=e.start,new Date(t).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}))),1),o("td",Se,d(e.notes||"No description"),1),o("td",Me,d((e.duration_minutes/60).toFixed(2))+"h ",1)]);var t}),128))])])])])):(y(),r("div",Ne,t[20]||(t[20]=[o("p",{class:"text-sm text-yellow-800"},[o("i",{class:"fas fa-info-circle mr-2"}),x(" No time entries recorded for this week. ")],-1)])))])):i("",!0),o("div",{class:"border-t border-gray-200 px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end"},[o("button",{onClick:rt,class:"px-4 py-2 bg-sage text-white rounded-md hover:bg-sage-dark text-sm font-semibold"}," Close ")])])],544)):i("",!0)])}}}),[["__scopeId","data-v-9725dcbc"]]);export{ze as default};
